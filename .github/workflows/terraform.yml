name: Multi-Environment Terraform CI/CD (Dev/Prod)

# This workflow can be triggered manually, allowing the user to select the target environment.
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target deployment environment (dev or prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Choose Terraform action'
        required: true
        default: 'plan_and_apply'
        type: choice
        options:
          - plan_and_apply # Runs plan and then apply
          - destroy        # Destroys infrastructure

jobs:
  terraform:
    # Job name now shows the environment being targeted
    name: ${{ github.event.inputs.action }} on ${{ github.event.inputs.environment }}
    runs-on: ubuntu-22.04

    # üö® CRITICAL SECURITY STEP: Required for OIDC role assumption
    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: "eu-north-1"
      # Set ENVIRONMENT variable from user input
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      # Dynamic Working Directory: points to 'terraform/dev' or 'terraform/prod'
      TF_WORKING_DIR: "terraform/${{ github.event.inputs.environment }}/src"
      # Admin IP Address
      ADMIN_IP: "125.209.112.98/32"
      # Dynamic Plan File Name: e.g., 'dev_tfplan.out' or 'prod_tfplan.out'
      TF_PLAN_FILE: ${{ github.event.inputs.environment }}_tfplan.out

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.13.5"

      # 3Ô∏è‚É£ Configure AWS credentials using OIDC (Environment-Specific Role)
      - name: Configure AWS Credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          output-env-credentials: true
          
          # üí° PROFESSIONAL DEVOPS: Dynamic Role Lookup
          # We are dynamically selecting the role ARN based on the environment input.
          # You MUST set secrets named 'AWS_ROLE_DEV' and 'AWS_ROLE_PROD' in GitHub.
         role-to-assume: "${{ secrets[format('AWS_ROLE_{0}', env.ENVIRONMENT.toUpperCase()] }}"


      # 4Ô∏è‚É£ Terraform Init with dynamic backend key
      - name: Terraform Init
        id: init
        run: |
          # The key is now environment-specific to isolate state files:
          # e.g., key=infra/dev/terraform.tfstate  or key=infra/prod/terraform.tfstate
          terraform -chdir="${{ env.TF_WORKING_DIR }}" init \
            -backend-config="bucket=tf-state-bucket-ci-cd" \
            -backend-config="key=infra/${{ env.ENVIRONMENT }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true"

      - name: Terraform Format Check & Validate
        run: |
          terraform -chdir=${{ env.TF_WORKING_DIR }} fmt -check
          terraform -chdir=${{ env.TF_WORKING_DIR }} validate

      - name: Terraform Plan and Save
        if: github.event.inputs.action == 'plan_and_apply'
        run: |
          terraform -chdir=${{ env.TF_WORKING_DIR }} plan -out=${{ env.TF_PLAN_FILE }}
      
      - name: Terraform Apply
        if: github.event.inputs.action == 'plan_and_apply'
        # IMPORTANT: Only 'prod' environment applies require manual approval
        # We add a job-level environment protection rule in GitHub settings for 'prod'.
        run: |
          terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve ../${{ env.TF_PLAN_FILE }}

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} destroy -auto-approve