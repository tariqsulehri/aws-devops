name: Terraform CI/CD with GitHub Actions

# Allow manual run and choose the action
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Choose Terraform action (Plan must run first for Apply)'
        required: true
        default: 'plan_and_apply'
        type: choice
        options:
          - plan_and_apply # Runs plan and then apply (consuming the plan)
          - destroy        # Destroys infrastructure

jobs:
  terraform:
    name: ${{ github.event.inputs.action }} Infrastructure
    runs-on: ubuntu-22.04

    # üö® CRITICAL SECURITY STEP: Set permissions for OIDC role assumption
    permissions:
      id-token: write # Required for OIDC
      contents: read  # Required for checkout

    env:
      AWS_REGION: "eu-north-1"
      TF_WORKING_DIR: terraform/src
      TF_PLAN_FILE: tfplan.out # Define the plan file name (saved to repository root)

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Terraform (using a more modern, stable constraint)
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          # Use a stable constraint for modern features and stability
          terraform_version: "~1.8.0" 

      # 3Ô∏è‚É£ Configure AWS credentials using OIDC (Security Best Practice)
      # NOTE: Requires configuring a trust relationship in your AWS IAM Role.
      - name: Configure AWS Credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Replace this with the IAM role ARN to assume in your AWS account
          role-to-assume: ${{ secrets.AWS_DEPLOYMENT_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # 4Ô∏è‚É£ Terraform Init with backend config
      - name: Terraform Init
        id: init
        run: |
          terraform -chdir="${{ env.TF_WORKING_DIR }}" init \
            -backend-config="bucket=tf-state-bucket-ci-cd" \
            -backend-config="key=infra/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true"

      # 5Ô∏è‚É£ Terraform Format Check
      - name: Terraform Format Check
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} fmt -check

      # 6Ô∏è‚É£ Terraform Validate
      - name: Terraform Validate
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} validate

      # 7Ô∏è‚É£ Terraform Plan and Save
      - name: Terraform Plan and Save
        if: github.event.inputs.action == 'plan_and_apply'
        run: |
          # The plan file is saved to the repository root
          terraform -chdir=${{ env.TF_WORKING_DIR }} plan -out=${{ env.TF_PLAN_FILE }}
      
      # 8Ô∏è‚É£ Terraform Apply (Consumes the Plan File)
      - name: Terraform Apply
        if: github.event.inputs.action == 'plan_and_apply'
        run: |
          # üêû CRITICAL FIX: Reference the plan file in the root directory (../) 
          # so Terraform can find it when executing from the working directory.
          terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve ../${{ env.TF_PLAN_FILE }}

      # 9Ô∏è‚É£ Terraform Destroy
      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        # IMPORTANT: This action is destructive and requires high caution!
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} destroy -auto-approve